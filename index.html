<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—É–±–ª–µ–∫.—Ä—É –ï–¥–∞</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #e85d6c;
            --primary-hover: #d64d5c;
            --secondary: #e8e6df;
            --secondary-hover: #dddbd4;
            --success: #5cb85c;
            --success-light: #7ce992;
            --danger: #e74c3c;
            --warning: #f0ad4e;
            --info: #5bc0de;
            --bg-main: #FDFDFE;
            --bg-card: #FDFDFE;
            --bg-input: #ffffff;
            --bg-header: #f8f8fa;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-light: #ffffff;
            --border: #e5e5e8;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius: 10px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .pulse { animation: pulse 2s infinite; }

        .container { max-width: 1200px; margin: 0 auto; }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .card:hover { box-shadow: var(--shadow-lg); }

        header {
            background: var(--bg-header);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, #ff8a80 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: -4px;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .section-header { 
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--secondary);
        }

        .sync-status.online {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-status.syncing .sync-dot {
            animation: pulse 1s infinite;
        }

        .readonly-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .readonly-banner .icon {
            font-size: 1.2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: var(--text-light);
            box-shadow: 0 2px 8px rgba(232, 93, 108, 0.3);
        }

        .btn-primary:hover:not(:disabled) { box-shadow: 0 4px 12px rgba(232, 93, 108, 0.4); }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) { background: var(--secondary-hover); }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #4a9d4a 100%);
            color: var(--text-light);
            box-shadow: 0 2px 8px rgba(92, 184, 92, 0.3);
        }

        .btn-add {
            background: linear-gradient(135deg, var(--success-light) 0%, var(--success) 100%);
            color: var(--text-primary);
            font-size: 0.8rem;
            padding: 6px 12px;
        }

        .btn-delete {
            background: var(--danger);
            color: var(--text-light);
            font-size: 0.8rem;
            padding: 6px 10px;
        }

        .btn-delete:hover:not(:disabled) { background: #c0392b; }

        .btn-back {
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-primary);
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 5px 10px;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 6px 10px;
        }

        .btn-ghost:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e09b3d 100%);
            color: var(--text-primary);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #46a5bf 100%);
            color: var(--text-light);
        }

        .participants-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 16px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: var(--radius);
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .participants-section label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .participants-section textarea {
            flex: 1;
            min-width: 200px;
            height: 40px;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            resize: none;
            font-size: 0.9rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--bg-input);
        }

        .participants-section textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(232, 93, 108, 0.1);
        }

        .participants-section textarea:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .input-field {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--bg-input);
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(232, 93, 108, 0.1);
        }

        .input-field:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .main-field {
            min-height: 200px;
            padding: 16px;
        }

        .type-row {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: var(--text-light);
            padding: 14px 18px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .type-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .type-name {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .type-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .type-actions { display: flex; gap: 8px; }

        .dish-row {
            background: var(--bg-input);
            padding: 12px 16px;
            border-radius: var(--radius);
            margin: 6px 0 6px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border);
            box-shadow: var(--shadow);
        }

        .dish-row:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .dish-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .dish-actions { display: flex; gap: 6px; }

        .ingredient-row {
            background: var(--bg-input);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            margin: 4px 0 4px 48px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr auto;
            gap: 12px;
            align-items: center;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            border-left: 3px solid var(--secondary);
        }

        .ingredient-row:hover {
            background: #fafafa;
            border-left-color: var(--primary);
        }

        .ingredient-row span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ingredient-name { font-weight: 500; }
        .ingredient-quantity { color: var(--text-secondary); }
        .ingredient-price { color: var(--success); font-weight: 500; }
        .ingredient-shop { color: var(--text-secondary); font-size: 0.8rem; }

        .total-row {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            margin: 4px 0 4px 48px;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 600;
            color: #155724;
        }

        .per-each-row {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            margin: 4px 0 8px 48px;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 500;
            color: #856404;
        }

        .per-person-section { background: var(--bg-card); }

        .per-person-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .per-person-item {
            background: var(--bg-input);
            padding: 14px 16px;
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }

        .per-person-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .per-person-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .per-person-name { font-weight: 500; }

        .per-person-amount {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .per-person-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .per-person-badge.deduction {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }

        .per-person-badge.addition {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }

        .per-person-final {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            padding-top: 8px;
            border-top: 1px dashed var(--border);
        }

        .per-person-final-amount {
            font-weight: 600;
            color: var(--success);
        }

        .norms-section { overflow-x: auto; }

        .norms-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }

        .norms-table th,
        .norms-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .norms-table th {
            background: var(--secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .norms-table th:first-child {
            border-radius: var(--radius) 0 0 0;
            text-align: left;
        }

        .norms-table th:last-child { border-radius: 0 var(--radius) 0 0; }

        .norms-table tbody tr { transition: var(--transition-fast); }
        .norms-table tbody tr:hover { background: rgba(0, 0, 0, 0.02); }

        .norms-table input[type="number"] {
            width: 70px;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            font-family: inherit;
            transition: var(--transition);
        }

        .norms-table input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .norms-table input[type="number"]:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .norms-table select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            width: 90px;
        }

        .norms-table select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .norms-table select:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .participant-header { min-width: 110px; padding: 8px !important; }

        .calorie-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }

        .calorie-input input { width: 65px; font-size: 0.8rem; }

        .type-header-row td { border-bottom: 2px solid var(--border) !important; }

        .shopping-section { background: var(--bg-card); }

        .shopping-stats {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 120px;
            height: 8px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--success-light) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .shopping-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .shopping-item {
            background: var(--bg-input);
            padding: 14px 16px;
            border-radius: var(--radius);
            display: grid;
            grid-template-columns: auto 1fr 100px 120px 100px;
            gap: 16px;
            align-items: center;
            font-size: 0.9rem;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .shopping-item:hover { box-shadow: var(--shadow-lg); }

        .shopping-item.purchased {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            opacity: 0.8;
        }

        .shopping-item.purchased .shopping-item-name,
        .shopping-item.purchased .shopping-item-quantity,
        .shopping-item.purchased .shopping-item-shop {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .shopping-header {
            background: var(--secondary);
            font-weight: 600;
            box-shadow: none;
            border: none;
        }

        .shopping-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--success);
            transition: var(--transition);
        }

        .shopping-checkbox:checked { animation: checkmark 0.3s ease; }
        .shopping-checkbox:disabled { cursor: not-allowed; }

        .shopping-item-name {
            font-weight: 500;
            display: flex;
            flex-direction: column;
        }

        .shopping-item-quantity { color: var(--text-secondary); }
        .shopping-item-shop { color: var(--text-secondary); font-size: 0.85rem; }

        .shopping-item-price {
            font-weight: 600;
            color: var(--primary);
            text-align: right;
        }

        .shopping-total {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: var(--text-light);
            font-weight: 600;
            margin-top: 8px;
            border: none;
        }

        .shopping-total .shopping-item-price {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .summary-section { background: var(--bg-card); }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: var(--bg-input);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .summary-card.clickable {
            cursor: pointer;
        }

        .summary-card.clickable:hover {
            border-color: var(--primary);
        }

        .summary-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .summary-hint {
            font-size: 0.7rem;
            color: var(--info);
            margin-top: 4px;
        }

        .summary-card.highlight {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            border: none;
        }

        .summary-card.highlight .summary-value,
        .summary-card.highlight .summary-label { color: var(--text-light); }

        .summary-card.contingency {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid var(--info);
        }

        .summary-card.contingency .summary-value {
            color: #1976d2;
        }

        .session-link-section { background: var(--bg-card); }

        .session-link-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-link-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .session-link-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
        }

        .session-link-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .owner-controls {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 16px;
            border-radius: var(--radius);
            margin-top: 16px;
            border: 1px solid #a5d6a7;
        }

        .owner-controls h4 {
            margin-bottom: 12px;
            color: #2e7d32;
            font-size: 0.95rem;
        }

        .owner-controls .control-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 48px;
            height: 24px;
            background: #ccc;
            border-radius: 24px;
            position: relative;
            transition: var(--transition);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: var(--transition);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .session-item {
            background: var(--bg-input);
            padding: 16px;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .session-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-lg);
        }

        .session-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .session-name { font-weight: 600; font-size: 1rem; }
        .session-date { font-size: 0.8rem; color: var(--text-secondary); }
        .session-owner { font-size: 0.75rem; color: var(--info); }
        .session-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        .create-session { display: flex; gap: 12px; flex-wrap: wrap; }
        .create-session input { flex: 1; min-width: 200px; }

        .empty-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
            text-align: center;
            padding: 24px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--bg-input);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(232, 93, 108, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .participants-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-input);
            border-radius: var(--radius);
            border: 2px solid var(--border);
        }

        .participant-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 6px 10px;
            background: var(--secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .participant-checkbox:hover { background: var(--secondary-hover); }
        .participant-checkbox input { accent-color: var(--primary); }

        .color-picker-group { flex-direction: row !important; align-items: center; }

        .color-picker-group input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            padding: 2px;
        }

        .radio-group {
            display: flex;
            gap: 16px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: var(--radius);
            border: 2px solid var(--border);
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input {
            accent-color: var(--primary);
        }

        .contingency-preview {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
            margin-top: 8px;
        }

        .contingency-preview .label {
            font-size: 0.85rem;
            color: #1976d2;
        }

        .contingency-preview .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1565c0;
        }

        .calc-current {
            background: linear-gradient(135deg, var(--secondary) 0%, #d8d6cf 100%);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 16px;
        }

        .calc-current-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .calc-current-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .calc-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .calc-input-group input {
            flex: 1;
        }

        .calc-result {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
            margin-top: 16px;
        }

        .calc-result-label {
            font-size: 0.85rem;
            color: #155724;
            margin-bottom: 4px;
        }

        .calc-result-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #155724;
        }

        .calc-history {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 2px solid var(--border);
        }

        .calc-history h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .calc-history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .calc-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .calc-history-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calc-history-type {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        .calc-history-type.deduction {
            background: #d4edda;
            color: #155724;
        }

        .calc-history-type.addition {
            background: #fff3cd;
            color: #856404;
        }

        .calc-history-amount {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .calc-history-date {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--text-primary);
            color: var(--text-light);
            padding: 14px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: var(--text-primary); }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            body { padding: 12px; }
            header { padding: 16px; }
            h1 { font-size: 1.4rem; }
            .header-top { flex-direction: column; align-items: flex-start; }
            .toolbar { flex-direction: column; }
            .toolbar .btn { width: 100%; }
            .ingredient-row { grid-template-columns: 1fr 1fr; margin-left: 24px; }
            .shopping-item { grid-template-columns: auto 1fr auto; }
            .shopping-item-shop, .shopping-item-quantity { display: none; }
            .form-row { grid-template-columns: 1fr; }
            .per-person-list { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .session-link-input { flex-direction: column; }
            .session-link-actions { flex-direction: column; }
            .session-link-actions .btn { width: 100%; }
            .calc-input-group { flex-direction: column; }
            .calc-input-group .btn { width: 100%; }
        }

        @media (max-width: 480px) {
            .shopping-item { grid-template-columns: auto 1fr; gap: 8px; }
            .shopping-item-price { grid-column: 2; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="container">
        <!-- ========== –°–¢–†–ê–ù–ò–¶–ê –°–ï–°–°–ò–ô ========== -->
        <div id="sessionsPage" class="hidden">
            <div class="card fade-in">
                <div class="logo">
                    <span class="logo-icon">ü•Ø</span>
                    <div>
                        <div class="logo-text">–ë—É–±–ª–µ–∫.—Ä—É</div>
                        <div class="logo-subtitle">–ï–¥–∞</div>
                    </div>
                </div>
                <p class="subtitle" style="margin-top: 12px;">–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –ª–µ–≥–∫–æ —Å –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π</p>
            </div>

            <div class="card fade-in">
                <h2>–ú–æ–∏ —Å–µ—Å—Å–∏–∏</h2>
                <div id="sessionsList" class="sessions-list"></div>
            </div>

            <div class="card fade-in">
                <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é</h2>
                <div class="create-session">
                    <input type="text" id="newSessionName" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞">
                    <button class="btn btn-primary" onclick="createSession()">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>

            <div class="card fade-in">
                <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ —Å—Å—ã–ª–∫–µ</h2>
                <div class="create-session">
                    <input type="text" id="joinSessionLink" class="input-field" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ—Å—Å–∏—é">
                    <button class="btn btn-success" onclick="joinByLink()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                </div>
            </div>
        </div>

        <!-- ========== –°–¢–†–ê–ù–ò–¶–ê –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê ========== -->
        <div id="calculatorPage" class="hidden">
            <header class="fade-in">
                <div class="header-top">
                    <button class="btn btn-back" onclick="goToSessions()">‚Üê –ù–∞–∑–∞–¥</button>
                    <h1 id="sessionTitle">–ë—É–±–ª–µ–∫.—Ä—É –ï–¥–∞</h1>
                    <div id="syncStatus" class="sync-status online">
                        <span class="sync-dot"></span>
                        <span class="sync-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                    </div>
                </div>

                <div id="readonlyBanner" class="readonly-banner hidden">
                    <span class="icon">üîí</span>
                    <span>–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é.</span>
                </div>

                <div class="participants-section">
                    <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</label>
                    <textarea id="participantsInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —á–∏—Å–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"></textarea>
                    <button class="btn btn-secondary" id="applyParticipantsBtn" onclick="applyParticipants()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>

                <div class="toolbar" id="mainToolbar">
                    <button class="btn btn-primary" onclick="showTypeModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø</button>
                    <button class="btn btn-primary" onclick="showDishModal()">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
                </div>
            </header>

            <main id="mainField" class="main-field card fade-in"></main>

            <section id="perPersonSection" class="per-person-section card fade-in hidden">
                <h3>–° –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
                <p class="section-subtitle">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å –≤—ã—á–µ—Ç–æ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º</p>
                <div id="perPersonList" style="margin-top: 16px;"></div>
            </section>

            <section id="normsSection" class="norms-section card fade-in hidden">
                <div class="section-header">
                    <h3>–¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π</h3>
                    <p class="section-subtitle">–£–∫–∞–∂–∏—Ç–µ, –∫—Ç–æ —á—Ç–æ –±—É–¥–µ—Ç –µ—Å—Ç—å</p>
                </div>
                <div id="normsTable"></div>
            </section>

            <section class="shopping-section card fade-in">
                <div class="section-header">
                    <h3>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h3>
                    <div class="shopping-stats">
                        <span id="purchasedCount">0</span> / <span id="totalCount">0</span> –∫—É–ø–ª–µ–Ω–æ
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                <div id="shoppingList"></div>
            </section>

            <section class="summary-section card fade-in">
                <div class="section-header">
                    <h3>–ò—Ç–æ–≥–æ–≤–∞—è —Å–º–µ—Ç–∞</h3>
                </div>
                <div id="summaryContent"></div>
            </section>

            <section class="session-link-section card fade-in">
                <div class="section-header">
                    <h3>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ—Å—Å–∏—é</h3>
                    <p class="section-subtitle">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                </div>
                <div class="session-link-container">
                    <div class="session-link-input">
                        <input type="text" id="sessionLinkInput" readonly>
                        <button class="btn btn-primary" onclick="copySessionLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="session-link-actions">
                        <button class="btn btn-info" onclick="shareSession()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                    </div>
                    
                    <div id="ownerControls" class="owner-controls hidden">
                        <h4>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞</h4>
                        <div class="control-row">
                            <label class="toggle-switch">
                                <input type="checkbox" id="readonlyToggle" onchange="toggleReadonly()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (–∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏–º)</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modalOverlay" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
        <div id="modalContent" class="modal-content"></div>
    </div>

    <!-- Toast –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase!
        const firebaseConfig = {
  apiKey: "AIzaSyBuQkcqVg_30Fho3Svq7Zz75Abwqcp5MBE",
  authDomain: "mikhailnbublek1.firebaseapp.com",
  databaseURL: "https://mikhailnbublek1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "mikhailnbublek1",
  storageBucket: "mikhailnbublek1.firebasestorage.app",
  messagingSenderId: "79990577838",
  appId: "1:79990577838:web:fdb2fa015da9adb2b16b3f"
};

        // Initialize Firebase
        let database;
        let firebaseInitialized = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseInitialized = true;
        } catch (e) {
            console.error('Firebase init error:', e);
        }

        // ============================================
        // STATE
        // ============================================
        let state = {
            sessionId: null,
            sessionName: '',
            ownerId: null,
            isReadonly: false,
            participants: [],
            participantCount: 0,
            types: [],
            dishes: [],
            ingredients: [],
            norms: {},
            participantCalories: {},
            purchased: {},
            participantAdjustments: {},
            contingency: {
                type: 'percent',
                value: 0
            }
        };

        let currentUserId = null;
        let sessionRef = null;
        let isOnline = true;
        let syncTimeout = null;
        let localSessions = {}; // –õ–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏

        // ============================================
        // LOCAL STORAGE FUNCTIONS
        // ============================================
        function loadLocalSessions() {
            try {
                const saved = localStorage.getItem('bublek_sessions');
                localSessions = saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('Load local sessions error:', e);
                localSessions = {};
            }
        }

        function saveLocalSessions() {
            try {
                localStorage.setItem('bublek_sessions', JSON.stringify(localSessions));
            } catch (e) {
                console.error('Save local sessions error:', e);
            }
        }

        function saveSessionLocally(sessionId, sessionData) {
            localSessions[sessionId] = {
                id: sessionId,
                name: sessionData.name,
                ownerId: sessionData.ownerId,
                isReadonly: sessionData.isReadonly || false,
                created: sessionData.created,
                lastAccessed: new Date().toISOString(),
                isOwner: sessionData.ownerId === currentUserId
            };
            saveLocalSessions();
        }

        function removeLocalSession(sessionId) {
            delete localSessions[sessionId];
            saveLocalSessions();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUserId = localStorage.getItem('bublek_userId');
            if (!currentUserId) {
                currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('bublek_userId', currentUserId);
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏
            loadLocalSessions();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ ID —Å–µ—Å—Å–∏–∏
            const urlParams = new URLSearchParams(window.location.search);
            const sessionIdFromUrl = urlParams.get('session');

            if (sessionIdFromUrl) {
                await openSession(sessionIdFromUrl);
            } else {
                showSessionsPage();
            }

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (firebaseInitialized) {
                database.ref('.info/connected').on('value', (snapshot) => {
                    isOnline = snapshot.val() === true;
                    updateSyncStatus();
                });
            }

            hideLoading();
        });

        function showLoading(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.querySelector('.loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateSyncStatus() {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;

            if (!firebaseInitialized) {
                statusEl.className = 'sync-status offline';
                statusEl.querySelector('.sync-text').textContent = '–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º';
            } else if (isOnline) {
                statusEl.className = 'sync-status online';
                statusEl.querySelector('.sync-text').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                statusEl.className = 'sync-status offline';
                statusEl.querySelector('.sync-text').textContent = '–û—Ñ–ª–∞–π–Ω';
            }
        }

        function setSyncingStatus() {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;
            statusEl.className = 'sync-status syncing';
            statusEl.querySelector('.sync-text').textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================
        function showSessionsPage() {
            document.getElementById('sessionsPage').classList.remove('hidden');
            document.getElementById('calculatorPage').classList.add('hidden');
            
            // –û—á–∏—â–∞–µ–º URL
            window.history.replaceState({}, '', window.location.pathname);
            
            renderLocalSessions();
        }

        function renderLocalSessions() {
            const container = document.getElementById('sessionsList');
            
            const sessionsList = Object.values(localSessions).sort((a, b) => 
                new Date(b.lastAccessed) - new Date(a.lastAccessed)
            );

            if (sessionsList.length === 0) {
                container.innerHTML = '<p class="empty-message">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
                return;
            }

            container.innerHTML = sessionsList.map((session, index) => `
                <div class="session-item fade-in" style="animation-delay: ${index * 0.05}s">
                    <div class="session-info">
                        <span class="session-name">${escapeHtml(session.name)}</span>
                        <span class="session-date">${formatDate(session.lastAccessed)}</span>
                        <span class="session-owner">${session.isOwner ? 'üëë –í—ã –≤–ª–∞–¥–µ–ª–µ—Ü' : 'üë§ –£—á–∞—Å—Ç–Ω–∏–∫'}</span>
                    </div>
                    <div class="session-actions">
                        <button class="btn btn-primary btn-small" onclick="openSession('${session.id}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                        <button class="btn btn-secondary btn-small" onclick="copyLink('${session.id}')">–°—Å—ã–ª–∫–∞</button>
                        <button class="btn btn-delete btn-small" onclick="removeFromList('${session.id}')">–£–±—Ä–∞—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        function removeFromList(sessionId) {
            if (!confirm('–£–±—Ä–∞—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞? (–°–∞–º–∞ —Å–µ—Å—Å–∏—è –Ω–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞)')) return;
            removeLocalSession(sessionId);
            renderLocalSessions();
            showToast('–°–µ—Å—Å–∏—è —É–±—Ä–∞–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞', 'success');
        }

        async function createSession() {
            const nameInput = document.getElementById('newSessionName');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞', 'warning');
                nameInput.focus();
                return;
            }

            if (!firebaseInitialized) {
                showToast('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                return;
            }

            showLoading('–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏...');

            try {
                const sessionId = 'session_' + Date.now();
                const sessionData = {
                    name: name,
                    ownerId: currentUserId,
                    created: new Date().toISOString(),
                    isReadonly: false,
                    data: {
                        participants: [],
                        participantCount: 0,
                        types: [],
                        dishes: [],
                        ingredients: [],
                        norms: {},
                        participantCalories: {},
                        purchased: {},
                        participantAdjustments: {},
                        contingency: { type: 'percent', value: 0 }
                    }
                };

                await database.ref(`sessions/${sessionId}`).set(sessionData);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                saveSessionLocally(sessionId, sessionData);
                
                nameInput.value = '';
                showToast('–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!', 'success');
                await openSession(sessionId);

            } catch (error) {
                console.error('Create session error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏', 'error');
                hideLoading();
            }
        }

        async function openSession(sessionId) {
            if (!firebaseInitialized) {
                showToast('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                return;
            }

            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏...');

            try {
                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏
                if (sessionRef) {
                    sessionRef.off();
                }

                sessionRef = database.ref(`sessions/${sessionId}`);
                
                const snapshot = await sessionRef.once('value');
                
                if (!snapshot.exists()) {
                    showToast('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    hideLoading();
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    removeLocalSession(sessionId);
                    showSessionsPage();
                    return;
                }

                const sessionData = snapshot.val();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                saveSessionLocally(sessionId, sessionData);

                state.sessionId = sessionId;
                state.sessionName = sessionData.name;
                state.ownerId = sessionData.ownerId;
                state.isReadonly = sessionData.isReadonly && sessionData.ownerId !== currentUserId;
                
                const data = sessionData.data || {};
                state.participants = data.participants || [];
                state.participantCount = data.participantCount || 0;
                state.types = data.types || [];
                state.dishes = data.dishes || [];
                state.ingredients = data.ingredients || [];
                state.norms = data.norms || {};
                state.participantCalories = data.participantCalories || {};
                state.purchased = data.purchased || {};
                state.participantAdjustments = data.participantAdjustments || {};
                state.contingency = data.contingency || { type: 'percent', value: 0 };

                // –û–±–Ω–æ–≤–ª—è–µ–º URL
                const newUrl = `${window.location.pathname}?session=${sessionId}`;
                window.history.replaceState({}, '', newUrl);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
                document.getElementById('sessionsPage').classList.add('hidden');
                document.getElementById('calculatorPage').classList.remove('hidden');
                
                document.getElementById('sessionTitle').textContent = sessionData.name;
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤
                setupUIForPermissions();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                if (state.participants.length > 0) {
                    document.getElementById('participantsInput').value = state.participants.join(', ');
                } else if (state.participantCount > 0) {
                    document.getElementById('participantsInput').value = state.participantCount.toString();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ—Å—Å–∏—é
                updateSessionLink();

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                sessionRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        handleRemoteUpdate(snapshot.val());
                    }
                });

                render();
                hideLoading();

            } catch (error) {
                console.error('Open session error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏', 'error');
                hideLoading();
                showSessionsPage();
            }
        }

        function handleRemoteUpdate(sessionData) {
            const data = sessionData.data || {};
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
            saveSessionLocally(state.sessionId, sessionData);
            
            state.sessionName = sessionData.name;
            state.ownerId = sessionData.ownerId;
            state.isReadonly = sessionData.isReadonly && sessionData.ownerId !== currentUserId;
            state.participants = data.participants || [];
            state.participantCount = data.participantCount || 0;
            state.types = data.types || [];
            state.dishes = data.dishes || [];
            state.ingredients = data.ingredients || [];
            state.norms = data.norms || {};
            state.participantCalories = data.participantCalories || {};
            state.purchased = data.purchased || {};
            state.participantAdjustments = data.participantAdjustments || {};
            state.contingency = data.contingency || { type: 'percent', value: 0 };

            setupUIForPermissions();
            render();
            updateSyncStatus();
        }

        function setupUIForPermissions() {
            const isOwner = state.ownerId === currentUserId;
            const canEditData = !state.isReadonly || isOwner;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
            document.getElementById('readonlyBanner').classList.toggle('hidden', canEditData);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞
            document.getElementById('ownerControls').classList.toggle('hidden', !isOwner);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º checkbox
            if (isOwner) {
                const toggle = document.getElementById('readonlyToggle');
                if (toggle) {
                    toggle.checked = state.isReadonly;
                }
            }

            // –û—Ç–∫–ª—é—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            document.getElementById('participantsInput').disabled = !canEditData;
            document.getElementById('applyParticipantsBtn').disabled = !canEditData;
            
            const toolbar = document.getElementById('mainToolbar');
            toolbar.querySelectorAll('.btn').forEach(btn => btn.disabled = !canEditData);
        }

        async function toggleReadonly() {
            if (!sessionRef) {
                showToast('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Å—Å–∏–∏', 'error');
                return;
            }

            const toggle = document.getElementById('readonlyToggle');
            const newValue = toggle.checked;
            
            setSyncingStatus();

            try {
                await sessionRef.update({ isReadonly: newValue });
                state.isReadonly = newValue;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
                if (localSessions[state.sessionId]) {
                    localSessions[state.sessionId].isReadonly = newValue;
                    saveLocalSessions();
                }
                
                updateSyncStatus();
                showToast(newValue ? '–†–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä" –≤–∫–ª—é—á—ë–Ω' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ', 'success');
            } catch (error) {
                console.error('Toggle readonly error:', error);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞
                toggle.checked = !newValue;
                updateSyncStatus();
                showToast('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ' + error.message, 'error');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            showLoading('–£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏...');

            try {
                await database.ref(`sessions/${sessionId}`).remove();
                removeLocalSession(sessionId);
                showToast('–°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
                renderLocalSessions();
            } catch (error) {
                console.error('Delete session error:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            }

            hideLoading();
        }

        function goToSessions() {
            if (sessionRef) {
                sessionRef.off();
                sessionRef = null;
            }
            state.sessionId = null;
            showSessionsPage();
        }

        // ============================================
        // SAVE TO FIREBASE
        // ============================================
        function saveSession() {
            if (!state.sessionId || !sessionRef) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (state.isReadonly && state.ownerId !== currentUserId) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            setSyncingStatus();

            // –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            clearTimeout(syncTimeout);
            syncTimeout = setTimeout(async () => {
                try {
                    await sessionRef.child('data').set({
                        participants: state.participants,
                        participantCount: state.participantCount,
                        types: state.types,
                        dishes: state.dishes,
                        ingredients: state.ingredients,
                        norms: state.norms,
                        participantCalories: state.participantCalories,
                        purchased: state.purchased,
                        participantAdjustments: state.participantAdjustments,
                        contingency: state.contingency
                    });
                    updateSyncStatus();
                } catch (error) {
                    console.error('Save error:', error);
                    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    updateSyncStatus();
                }
            }, 500);
        }

        // ============================================
        // SESSION LINK
        // ============================================
        function updateSessionLink() {
            const link = `${window.location.origin}${window.location.pathname}?session=${state.sessionId}`;
            document.getElementById('sessionLinkInput').value = link;
        }

        function copySessionLink() {
            const link = document.getElementById('sessionLinkInput').value;
            copyToClipboard(link);
            showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
        }

        function copyLink(sessionId) {
            const link = `${window.location.origin}${window.location.pathname}?session=${sessionId}`;
            copyToClipboard(link);
            showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
        }

        async function shareSession() {
            const link = document.getElementById('sessionLinkInput').value;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: state.sessionName,
                        text: `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é: ${state.sessionName}`,
                        url: link
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        copySessionLink();
                    }
                }
            } else {
                copySessionLink();
            }
        }

        function joinByLink() {
            const input = document.getElementById('joinSessionLink');
            const link = input.value.trim();
            
            if (!link) {
                showToast('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É', 'warning');
                return;
            }

            try {
                const url = new URL(link);
                const sessionId = url.searchParams.get('session');
                
                if (sessionId) {
                    input.value = '';
                    openSession(sessionId);
                } else {
                    showToast('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞', 'error');
                }
            } catch (e) {
                // –í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ID —Å–µ—Å—Å–∏–∏
                if (link.startsWith('session_')) {
                    input.value = '';
                    openSession(link);
                } else {
                    showToast('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞', 'error');
                }
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); } catch (e) { }
            document.body.removeChild(textarea);
        }

        // ============================================
        // PARTICIPANTS
        // ============================================
        function applyParticipants() {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            const input = document.getElementById('participantsInput').value.trim();

            if (!input) {
                state.participants = [];
                state.participantCount = 0;
            } else if (/^\d+$/.test(input)) {
                state.participants = [];
                state.participantCount = parseInt(input);
            } else {
                state.participants = input.split(',').map(p => p.trim()).filter(p => p);
                state.participantCount = state.participants.length;
            }

            state.participants.forEach(p => {
                if (!state.participantCalories[p]) {
                    state.participantCalories[p] = 2000;
                }
                if (!state.participantAdjustments[p]) {
                    state.participantAdjustments[p] = [];
                }
            });

            state.dishes.forEach(dish => {
                if (!state.norms[dish.id]) {
                    state.norms[dish.id] = {};
                }
                state.participants.forEach(p => {
                    if (state.norms[dish.id][p] === undefined) {
                        state.norms[dish.id][p] = 2;
                    }
                });
            });

            saveSession();
            render();
            showToast('–£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }

        function canEdit() {
            return !state.isReadonly || state.ownerId === currentUserId;
        }

        // ============================================
        // MODAL
        // ============================================
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // ============================================
        // CONTINGENCY
        // ============================================
        function showContingencyModal() {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            const baseCost = state.ingredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            const currentContingency = calculateContingency();

            showModal(`
                <h3>üí∞ –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</h3>
                <div class="modal-form">
                    <div class="calc-current">
                        <div class="calc-current-label">–ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –±–ª—é–¥</div>
                        <div class="calc-current-amount">${formatMoney(baseCost)}</div>
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø —Ä–∞—Å—á—ë—Ç–∞:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="contingencyType" value="percent" 
                                    ${state.contingency.type === 'percent' ? 'checked' : ''}
                                    onchange="updateContingencyPreview()">
                                –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—É–º–º—ã
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="contingencyType" value="fixed" 
                                    ${state.contingency.type === 'fixed' ? 'checked' : ''}
                                    onchange="updateContingencyPreview()">
                                –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="percentGroup" ${state.contingency.type === 'fixed' ? 'style="display:none"' : ''}>
                        <label>–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ (%):</label>
                        <input type="number" id="contingencyPercent" class="input-field" 
                            min="0" max="100" step="1" 
                            value="${state.contingency.type === 'percent' ? state.contingency.value : 10}"
                            oninput="updateContingencyPreview()">
                    </div>

                    <div class="form-group" id="fixedGroup" ${state.contingency.type === 'percent' ? 'style="display:none"' : ''}>
                        <label>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ (—Ä—É–±.):</label>
                        <input type="number" id="contingencyFixed" class="input-field" 
                            min="0" step="100" 
                            value="${state.contingency.type === 'fixed' ? state.contingency.value : 0}"
                            oninput="updateContingencyPreview()">
                    </div>

                    <div class="contingency-preview">
                        <div class="label">–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Å–æ—Å—Ç–∞–≤—è—Ç:</div>
                        <div class="value" id="contingencyPreviewValue">${formatMoney(currentContingency)}</div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="clearContingency()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                                                <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveContingency()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞
            document.querySelectorAll('input[name="contingencyType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('percentGroup').style.display = this.value === 'percent' ? '' : 'none';
                    document.getElementById('fixedGroup').style.display = this.value === 'fixed' ? '' : 'none';
                    updateContingencyPreview();
                });
            });
        }

        function updateContingencyPreview() {
            const type = document.querySelector('input[name="contingencyType"]:checked').value;
            const baseCost = state.ingredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            let contingency = 0;

            if (type === 'percent') {
                const percent = parseFloat(document.getElementById('contingencyPercent').value) || 0;
                contingency = baseCost * (percent / 100);
            } else {
                contingency = parseFloat(document.getElementById('contingencyFixed').value) || 0;
            }

            document.getElementById('contingencyPreviewValue').textContent = formatMoney(contingency);
        }

        function saveContingency() {
            const type = document.querySelector('input[name="contingencyType"]:checked').value;
            let value = 0;

            if (type === 'percent') {
                value = parseFloat(document.getElementById('contingencyPercent').value) || 0;
            } else {
                value = parseFloat(document.getElementById('contingencyFixed').value) || 0;
            }

            state.contingency = { type, value };
            saveSession();
            closeModal();
            render();
            showToast('–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }

        function clearContingency() {
            state.contingency = { type: 'percent', value: 0 };
            saveSession();
            closeModal();
            render();
            showToast('–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
        }

        function calculateContingency() {
            const baseCost = state.ingredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            
            if (state.contingency.type === 'percent') {
                return baseCost * (state.contingency.value / 100);
            } else {
                return state.contingency.value;
            }
        }

        // ============================================
        // PARTICIPANT CALCULATION MODAL
        // ============================================
        function showParticipantCalcModal(participantName) {
            const perParticipant = calculatePerParticipant();
            const baseAmount = perParticipant[participantName] || 0;
            const adjustments = state.participantAdjustments[participantName] || [];
            
            const totalAdjustment = adjustments.reduce((sum, adj) => {
                return adj.type === 'deduction' ? sum - adj.amount : sum + adj.amount;
            }, 0);
            const finalAmount = baseAmount + totalAdjustment;

            const historyHtml = adjustments.length > 0 ? `
                <div class="calc-history">
                    <h4>–ò—Å—Ç–æ—Ä–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫</h4>
                    <div class="calc-history-list">
                        ${adjustments.map((adj, index) => `
                            <div class="calc-history-item">
                                <div class="calc-history-info">
                                    <span class="calc-history-type ${adj.type}">${adj.type === 'deduction' ? '‚ûñ –í—ã—á–µ—Ç' : '‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ'}</span>
                                    <span class="calc-history-amount">${formatMoney(adj.amount)}</span>
                                    <span class="calc-history-date">${formatDateTime(adj.date)}</span>
                                </div>
                                ${canEdit() ? `<button class="btn btn-delete btn-small" onclick="deleteAdjustment('${escapeHtml(participantName)}', ${index})">√ó</button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            const editControls = canEdit() ? `
                <div class="form-group">
                    <label>–í—ã—á–µ—Å—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å (—Ä—É–±.):</label>
                    <div class="calc-input-group">
                        <input type="number" id="adjustmentAmount" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="0" step="0.01">
                        <button class="btn btn-success" onclick="addAdjustment('${escapeHtml(participantName)}', 'deduction')">‚ûñ –í—ã—á–µ—Å—Ç—å</button>
                        <button class="btn btn-warning" onclick="addAdjustment('${escapeHtml(participantName)}', 'addition')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            ` : '';

            showModal(`
                <h3>–†–∞—Å—á—ë—Ç –¥–ª—è ${escapeHtml(participantName)}</h3>
                <div class="modal-form">
                    <div class="calc-current">
                        <div class="calc-current-label">–ë–∞–∑–æ–≤–∞—è —Å—É–º–º–∞ (—Å –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞)</div>
                        <div class="calc-current-amount">${formatMoney(baseAmount)}</div>
                    </div>

                    ${editControls}

                    <div class="calc-result">
                        <div class="calc-result-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
                        <div class="calc-result-amount">${formatMoney(finalAmount)}</div>
                    </div>

                    ${historyHtml}

                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `);
        }

        function addAdjustment(participantName, type) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            const amountInput = document.getElementById('adjustmentAmount');
            const amount = parseFloat(amountInput.value);

            if (!amount || amount <= 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'warning');
                amountInput.focus();
                return;
            }

            if (!state.participantAdjustments[participantName]) {
                state.participantAdjustments[participantName] = [];
            }

            state.participantAdjustments[participantName].push({
                type: type,
                amount: amount,
                date: new Date().toISOString()
            });

            saveSession();
            showToast(type === 'deduction' ? '–í—ã—á–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
            
            showParticipantCalcModal(participantName);
            renderPerPerson();
        }

        function deleteAdjustment(participantName, index) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            if (!state.participantAdjustments[participantName]) return;

            state.participantAdjustments[participantName].splice(index, 1);
            saveSession();
            showToast('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
            
            showParticipantCalcModal(participantName);
            renderPerPerson();
        }

        function getParticipantAdjustmentStatus(participantName) {
            const adjustments = state.participantAdjustments[participantName] || [];
            if (adjustments.length === 0) return null;

            const totalAdjustment = adjustments.reduce((sum, adj) => {
                return adj.type === 'deduction' ? sum - adj.amount : sum + adj.amount;
            }, 0);

            if (totalAdjustment < 0) {
                return { type: 'deduction', amount: Math.abs(totalAdjustment) };
            } else if (totalAdjustment > 0) {
                return { type: 'addition', amount: totalAdjustment };
            }
            return null;
        }

        function formatDateTime(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '';
            }
        }

        // ============================================
        // TYPE FUNCTIONS
        // ============================================
        function showTypeModal(editId = null) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            const type = editId ? state.types.find(t => t.id === editId) : null;
            const isEdit = !!type;

            const participantsHtml = state.participants.length > 0 ? `
                <div class="form-group">
                    <label>–î–ª—è –∫–æ–≥–æ:</label>
                    <div class="participants-checkboxes">
                        <label class="participant-checkbox">
                            <input type="checkbox" id="typeForAll" ${!type || type.forAll ? 'checked' : ''}>
                            –î–ª—è –≤—Å–µ—Ö
                        </label>
                        ${state.participants.map(p => `
                            <label class="participant-checkbox">
                                <input type="checkbox" class="type-participant" value="${escapeHtml(p)}" 
                                    ${type && type.participants && type.participants.includes(p) ? 'checked' : ''}>
                                ${escapeHtml(p)}
                            </label>
                        `).join('')}
                    </div>
                </div>
            ` : `
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:</label>
                    <input type="number" id="typePersonCount" class="input-field" min="1" 
                        value="${type ? type.personCount || state.participantCount || 1 : state.participantCount || 1}">
                </div>
            `;

            showModal(`
                <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞'}</h3>
                <div class="modal-form">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞:</label>
                        <input type="text" id="typeName" class="input-field" value="${type ? escapeHtml(type.name) : ''}" 
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–ª–∞—Ç—ã, –ì–æ—Ä—è—á–µ–µ, –ù–∞–ø–∏—Ç–∫–∏">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-10):</label>
                            <input type="number" id="typePriority" class="input-field" min="1" max="10" value="${type ? type.priority : 5}">
                        </div>
                        <div class="form-group color-picker-group">
                            <label>–¶–≤–µ—Ç:</label>
                            <input type="color" id="typeColor" value="${type ? type.color : '#e85d6c'}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–ù–æ—Ä–º–∞ –∫–≥ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞:</label>
                        <input type="number" id="typeNormKg" class="input-field" step="0.01" min="0" 
                            value="${type ? type.normKg || '' : ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 0.3">
                    </div>
                    ${participantsHtml}
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveType('${editId || ''}')">${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}</button>
                    </div>
                </div>
            `);

            if (state.participants.length > 0) {
                const forAllCheckbox = document.getElementById('typeForAll');
                const participantCheckboxes = document.querySelectorAll('.type-participant');
                
                forAllCheckbox.addEventListener('change', function() {
                    participantCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                        cb.disabled = this.checked;
                    });
                });
                
                if (forAllCheckbox.checked) {
                    participantCheckboxes.forEach(cb => cb.disabled = true);
                }
            }

            setTimeout(() => document.getElementById('typeName').focus(), 100);
        }

        function saveType(editId) {
            const name = document.getElementById('typeName').value.trim();
            const priority = parseInt(document.getElementById('typePriority').value) || 5;
            const color = document.getElementById('typeColor').value;
            const normKg = parseFloat(document.getElementById('typeNormKg').value) || 0;

            if (!name) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞', 'warning');
                return;
            }

            let forAll = true;
            let participants = [];
            let personCount = state.participantCount;

            if (state.participants.length > 0) {
                forAll = document.getElementById('typeForAll').checked;
                if (!forAll) {
                    participants = Array.from(document.querySelectorAll('.type-participant:checked')).map(cb => cb.value);
                }
            } else {
                personCount = parseInt(document.getElementById('typePersonCount').value) || 1;
            }

            if (editId) {
                const index = state.types.findIndex(t => t.id === editId);
                if (index !== -1) {
                    state.types[index] = { ...state.types[index], name, priority, color, normKg, forAll, participants, personCount };
                }
            } else {
                state.types.push({
                    id: 'type_' + Date.now(),
                    name, priority, color, normKg, forAll, participants, personCount
                });
            }

            state.types.sort((a, b) => a.priority - b.priority);
            saveSession();
            closeModal();
            render();
            showToast(editId ? '–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω' : '–¢–∏–ø –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }

        function deleteType(typeId) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø —Å–æ –≤—Å–µ–º–∏ –±–ª—é–¥–∞–º–∏ –∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏?')) return;

            const dishIds = state.dishes.filter(d => d.typeId === typeId).map(d => d.id);
            state.ingredients = state.ingredients.filter(i => !dishIds.includes(i.dishId) && i.typeId !== typeId);
            state.dishes = state.dishes.filter(d => d.typeId !== typeId);
            state.types = state.types.filter(t => t.id !== typeId);

            dishIds.forEach(id => {
                delete state.norms[id];
                delete state.purchased[id];
            });

            saveSession();
            render();
            showToast('–¢–∏–ø —É–¥–∞–ª–µ–Ω', 'success');
        }

        // ============================================
        // DISH FUNCTIONS
        // ============================================
        function showDishModal(editId = null) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            const dish = editId ? state.dishes.find(d => d.id === editId) : null;
            const isEdit = !!dish;

            const typesOptions = state.types.map(t => 
                `<option value="${t.id}" ${dish && dish.typeId === t.id ? 'selected' : ''}>${escapeHtml(t.name)}</option>`
            ).join('');

            const participantsHtml = state.participants.length > 0 ? `
                <div class="form-group">
                    <label>–î–ª—è –∫–æ–≥–æ:</label>
                    <div class="participants-checkboxes">
                        <label class="participant-checkbox">
                            <input type="checkbox" id="dishForAll" ${!dish || dish.forAll ? 'checked' : ''}>
                            –î–ª—è –≤—Å–µ—Ö
                        </label>
                        ${state.participants.map(p => `
                            <label class="participant-checkbox">
                                <input type="checkbox" class="dish-participant" value="${escapeHtml(p)}"
                                    ${dish && dish.participants && dish.participants.includes(p) ? 'checked' : ''}>
                                ${escapeHtml(p)}
                            </label>
                        `).join('')}
                    </div>
                </div>
            ` : `
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:</label>
                    <input type="number" id="dishPersonCount" class="input-field" min="1" 
                        value="${dish ? dish.personCount || state.participantCount || 1 : state.participantCount || 1}">
                </div>
            `;

            showModal(`
                <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª—é–¥–∞' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞'}</h3>
                <div class="modal-form">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="dishName" class="input-field" value="${dish ? escapeHtml(dish.name) : ''}" 
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–ª–∏–≤—å–µ, –®–∞—à–ª—ã–∫">
                    </div>
                    <div class="form-group">
                        <label>–¢–∏–ø:</label>
                        <select id="dishType" class="input-field">
                            <option value="">-- –ë–µ–∑ —Ç–∏–ø–∞ --</option>
                            ${typesOptions}
                        </select>
                    </div>
                    ${participantsHtml}
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveDish('${editId || ''}')">${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}</button>
                    </div>
                </div>
            `);

            if (state.participants.length > 0) {
                const forAllCheckbox = document.getElementById('dishForAll');
                const participantCheckboxes = document.querySelectorAll('.dish-participant');
                
                forAllCheckbox.addEventListener('change', function() {
                    participantCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                        cb.disabled = this.checked;
                    });
                });
                
                if (forAllCheckbox.checked) {
                    participantCheckboxes.forEach(cb => cb.disabled = true);
                }
            }

            setTimeout(() => document.getElementById('dishName').focus(), 100);
        }

        function saveDish(editId) {
            const name = document.getElementById('dishName').value.trim();
            const typeId = document.getElementById('dishType').value;

            if (!name) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞', 'warning');
                return;
            }

            let forAll = true;
            let participants = [];
            let personCount = state.participantCount;

            if (state.participants.length > 0) {
                forAll = document.getElementById('dishForAll').checked;
                if (!forAll) {
                    participants = Array.from(document.querySelectorAll('.dish-participant:checked')).map(cb => cb.value);
                }
            } else {
                personCount = parseInt(document.getElementById('dishPersonCount').value) || 1;
            }

            if (editId) {
                const index = state.dishes.findIndex(d => d.id === editId);
                if (index !== -1) {
                    state.dishes[index] = { ...state.dishes[index], name, typeId, forAll, participants, personCount };
                }
            } else {
                const newDish = {
                    id: 'dish_' + Date.now(),
                    name, typeId, forAll, participants, personCount,
                    order: state.dishes.length
                };
                state.dishes.push(newDish);

                if (state.participants.length > 0) {
                    state.norms[newDish.id] = {};
                    state.participants.forEach(p => {
                        state.norms[newDish.id][p] = 2;
                    });
                }
            }

            saveSession();
            closeModal();
            render();
            showToast(editId ? '–ë–ª—é–¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ë–ª—é–¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
        }

        function deleteDish(dishId) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            if (!confirm('–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ —Å–æ –≤—Å–µ–º–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏?')) return;

            state.ingredients = state.ingredients.filter(i => i.dishId !== dishId);
            state.dishes = state.dishes.filter(d => d.id !== dishId);
            delete state.norms[dishId];

            saveSession();
            render();
            showToast('–ë–ª—é–¥–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
        }

        // ============================================
        // INGREDIENT FUNCTIONS
        // ============================================
        function showIngredientModal(parentType, parentId, editId = null) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            const ingredient = editId ? state.ingredients.find(i => i.id === editId) : null;
            const isEdit = !!ingredient;

            showModal(`
                <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞'}</h3>
                <div class="modal-form">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="ingredientName" class="input-field" 
                            value="${ingredient ? escapeHtml(ingredient.name) : ''}" 
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å, –ú–∞–π–æ–Ω–µ–∑">
                    </div>
                    <div class="form-group">
                        <label>–ú–∞–≥–∞–∑–∏–Ω:</label>
                        <input type="text" id="ingredientShop" class="input-field" 
                            value="${ingredient ? escapeHtml(ingredient.shop || '') : ''}" 
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—è—Ç—ë—Ä–æ—á–∫–∞, –ú–∞–≥–Ω–∏—Ç">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                            <input type="number" id="ingredientQuantity" class="input-field" step="0.01" min="0" 
                                value="${ingredient ? ingredient.quantity : ''}" placeholder="1.5">
                        </div>
                        <div class="form-group">
                            <label>–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è:</label>
                            <select id="ingredientUnit" class="input-field">
                                <option value="–∫–≥" ${ingredient && ingredient.unit === '–∫–≥' ? 'selected' : ''}>–∫–∏–ª–æ–≥—Ä–∞–º–º</option>
                                <option value="–≥" ${ingredient && ingredient.unit === '–≥' ? 'selected' : ''}>–≥—Ä–∞–º–º</option>
                                <option value="–ª" ${ingredient && ingredient.unit === '–ª' ? 'selected' : ''}>–ª–∏—Ç—Ä</option>
                                <option value="–º–ª" ${ingredient && ingredient.unit === '–º–ª' ? 'selected' : ''}>–º–∏–ª–ª–∏–ª–∏—Ç—Ä</option>
                                <option value="—à—Ç" ${ingredient && ingredient.unit === '—à—Ç' ? 'selected' : ''}>—à—Ç—É–∫–∞</option>
                                <option value="—É–ø" ${ingredient && ingredient.unit === '—É–ø' ? 'selected' : ''}>—É–ø–∞–∫–æ–≤–∫–∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—Ä—É–±.):</label>
                        <input type="number" id="ingredientPrice" class="input-field" step="0.01" min="0" 
                            value="${ingredient ? ingredient.price : ''}" placeholder="100.00">
                    </div>
                    <div class="form-group" style="background: var(--secondary); padding: 12px; border-radius: var(--radius);">
                        <label style="font-weight: 600;">–ò—Ç–æ–≥–æ: <span id="ingredientTotal" style="color: var(--primary); font-size: 1.2rem;">0.00</span> —Ä—É–±.</label>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveIngredient('${parentType}', '${parentId}', '${editId || ''}')">${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}</button>
                    </div>
                </div>
            `);

            const updateTotal = () => {
                const qty = parseFloat(document.getElementById('ingredientQuantity').value) || 0;
                const price = parseFloat(document.getElementById('ingredientPrice').value) || 0;
                document.getElementById('ingredientTotal').textContent = (qty * price).toFixed(2);
            };

            document.getElementById('ingredientQuantity').addEventListener('input', updateTotal);
            document.getElementById('ingredientPrice').addEventListener('input', updateTotal);
            updateTotal();

            setTimeout(() => document.getElementById('ingredientName').focus(), 100);
        }

        function saveIngredient(parentType, parentId, editId) {
            const name = document.getElementById('ingredientName').value.trim();
            const shop = document.getElementById('ingredientShop').value.trim();
            const quantity = parseFloat(document.getElementById('ingredientQuantity').value) || 0;
            const unit = document.getElementById('ingredientUnit').value;
            const price = parseFloat(document.getElementById('ingredientPrice').value) || 0;

            if (!name) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞', 'warning');
                return;
            }

            if (quantity <= 0) {
                showToast('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'warning');
                return;
            }

            if (editId) {
                const index = state.ingredients.findIndex(i => i.id === editId);
                if (index !== -1) {
                    state.ingredients[index] = { ...state.ingredients[index], name, shop, quantity, unit, price };
                }
            } else {
                state.ingredients.push({
                    id: 'ing_' + Date.now(),
                    name, shop, quantity, unit, price,
                    typeId: parentType === 'type' ? parentId : null,
                    dishId: parentType === 'dish' ? parentId : null,
                    order: state.ingredients.length
                });
            }

            saveSession();
            closeModal();
            render();
            showToast(editId ? '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }

        function deleteIngredient(ingredientId) {
            if (!canEdit()) {
                showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'warning');
                return;
            }

            state.ingredients = state.ingredients.filter(i => i.id !== ingredientId);
            saveSession();
            render();
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function render() {
            renderMainField();
            renderPerPerson();
            renderNormsTable();
            renderShoppingList();
            renderSummary();
        }

        function renderMainField() {
            const main = document.getElementById('mainField');
            const editable = canEdit();
            let html = '';

            state.types.forEach((type, index) => {
                html += `<div class="type-container fade-in" style="animation-delay: ${index * 0.05}s">`;
                html += renderType(type, editable);
                html += `</div>`;
            });

            const dishesWithoutType = state.dishes.filter(d => !d.typeId);
            dishesWithoutType.forEach((dish, index) => {
                html += `<div class="dish-container fade-in" style="animation-delay: ${(state.types.length + index) * 0.05}s">`;
                html += renderDish(dish, editable);
                html += `</div>`;
            });

            main.innerHTML = html || '<p class="empty-message">–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –±–ª—é–¥ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –±–ª—é–¥–∞</p>';
        }

        function renderType(type, editable) {
            const typeIngredients = state.ingredients.filter(i => i.typeId === type.id);
            const typeDishes = state.dishes.filter(d => d.typeId === type.id);
            const dishCount = typeDishes.length;

            let html = `
                <div class="type-row" style="background: linear-gradient(135deg, ${type.color} 0%, ${adjustColor(type.color, -20)} 100%)" 
                    onclick="${editable ? `showTypeModal('${type.id}')` : ''}">
                    <span class="type-name">
                        ${escapeHtml(type.name)}
                        <span class="type-badge">${dishCount} ${pluralize(dishCount, '–±–ª—é–¥–æ', '–±–ª—é–¥–∞', '–±–ª—é–¥')}</span>
                        ${type.normKg ? `<span class="type-badge">${type.normKg} –∫–≥/—á–µ–ª</span>` : ''}
                    </span>
                    <div class="type-actions" onclick="event.stopPropagation()">
                        ${editable ? `
                            <button class="btn btn-add btn-small" onclick="showIngredientModal('type', '${type.id}')">+ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button>
                            <button class="btn btn-delete btn-small" onclick="deleteType('${type.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                        ` : ''}
                    </div>
                </div>
            `;

            typeIngredients.forEach(ing => {
                html += renderIngredient(ing, editable);
            });

            if (typeIngredients.length > 0) {
                const total = typeIngredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
                const perPerson = calculatePerPerson(total, type);
                html += `
                    <div class="total-row">
                        <span>–ò—Ç–æ–≥–æ –∑–∞ —Ç–∏–ø:</span>
                        <span>${formatMoney(total)}</span>
                    </div>
                    <div class="per-each-row">
                        <span>–° –∫–∞–∂–¥–æ–≥–æ:</span>
                        <span>${formatMoney(perPerson)}</span>
                    </div>
                `;
            }

            typeDishes.forEach(dish => {
                html += renderDish(dish, editable);
            });

            return html;
        }

        function renderDish(dish, editable) {
            const dishIngredients = state.ingredients.filter(i => i.dishId === dish.id);

            let html = `
                <div class="dish-row" onclick="${editable ? `showDishModal('${dish.id}')` : ''}">
                    <span class="dish-name">${escapeHtml(dish.name)}</span>
                    <div class="dish-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-ghost btn-small" onclick="showParticipantsInfo('${dish.id}')" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
                            ${getParticipantsCount(dish)} —á–µ–ª.
                        </button>
                        ${editable ? `
                            <button class="btn btn-add btn-small" onclick="showIngredientModal('dish', '${dish.id}')">+ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button>
                            <button class="btn btn-delete btn-small" onclick="deleteDish('${dish.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                        ` : ''}
                    </div>
                </div>
            `;

            dishIngredients.forEach(ing => {
                html += renderIngredient(ing, editable);
            });

            if (dishIngredients.length > 0) {
                const total = dishIngredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
                const perPerson = calculatePerPersonForDish(dish, total);
                html += `
                    <div class="total-row">
                        <span>–ò—Ç–æ–≥–æ –∑–∞ –±–ª—é–¥–æ:</span>
                        <span>${formatMoney(total)}</span>
                    </div>
                    <div class="per-each-row">
                        <span>–° –∫–∞–∂–¥–æ–≥–æ:</span>
                        <span>${formatMoney(perPerson)}</span>
                    </div>
                `;
            }

            return html;
        }

        function renderIngredient(ing, editable) {
            const total = ing.quantity * ing.price;
            return `
                <div class="ingredient-row" onclick="${editable ? `showIngredientModal('${ing.typeId ? 'type' : 'dish'}', '${ing.typeId || ing.dishId}', '${ing.id}')` : ''}">
                    <span class="ingredient-name">${escapeHtml(ing.name)}</span>
                    <span class="ingredient-quantity">${ing.quantity} ${ing.unit}</span>
                    <span class="ingredient-price">${formatMoney(ing.price)}</span>
                    <span class="ingredient-price">${formatMoney(total)}</span>
                    <span class="ingredient-shop">${escapeHtml(ing.shop || '‚Äî')}</span>
                    ${editable ? `<button class="btn btn-delete btn-small" onclick="event.stopPropagation(); deleteIngredient('${ing.id}')">√ó</button>` : '<span></span>'}
                </div>
            `;
        }

        function getParticipantsCount(dish) {
            if (state.participants.length > 0) {
                if (dish.forAll) return state.participants.length;
                return dish.participants ? dish.participants.length : 0;
            }
            return dish.personCount || state.participantCount || 0;
        }

        function showParticipantsInfo(dishId) {
            const dish = state.dishes.find(d => d.id === dishId);
            if (!dish) return;

            let info = '';
            if (state.participants.length > 0) {
                if (dish.forAll) {
                    info = '–î–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n' + state.participants.join(', ');
                } else {
                    info = '–î–ª—è: ' + (dish.participants && dish.participants.length > 0 ? dish.participants.join(', ') : '–Ω–∏–∫–æ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ');
                }
            } else {
                info = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫: ' + (dish.personCount || state.participantCount || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ');
            }

            alert(info);
        }

        // ============================================
        // CALCULATION FUNCTIONS
        // ============================================
        function getNormValue(dishId, participant) {
            if (state.norms[dishId] && state.norms[dishId][participant] !== undefined) {
                return state.norms[dishId][participant];
            }
            return 2;
        }

        function calculatePerPerson(total, entity) {
            if (state.participants.length > 0) {
                if (entity.forAll) {
                    return total / state.participants.length;
                }
                return entity.participants && entity.participants.length > 0 ? total / entity.participants.length : total;
            }
            return entity.personCount > 0 ? total / entity.personCount : total;
        }

        function calculatePerPersonForDish(dish, total) {
            if (state.participants.length > 0) {
                let totalMultiplier = 0;

                state.participants.forEach(p => {
                    const normValue = getNormValue(dish.id, p);
                    if (normValue === 2) {
                        totalMultiplier += 1;
                    } else if (normValue === 1) {
                        totalMultiplier += 0.5;
                    }
                });

                if (totalMultiplier === 0) return 0;
                return total / totalMultiplier;
            }

            return dish.personCount > 0 ? total / dish.personCount : total;
        }

        function calculatePerParticipant() {
            const perParticipant = {};
            const contingency = calculateContingency();
            const participantsCount = state.participants.length || state.participantCount || 1;
            const contingencyPerPerson = contingency / participantsCount;

            state.participants.forEach(p => perParticipant[p] = contingencyPerPerson);

            state.dishes.forEach(dish => {
                const dishIngredients = state.ingredients.filter(i => i.dishId === dish.id);
                const total = dishIngredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);

                if (total > 0) {
                    let participants = dish.forAll ? state.participants : (dish.participants || []);
                    let participantMultipliers = {};
                    let totalMultiplier = 0;

                    participants.forEach(p => {
                        const normValue = getNormValue(dish.id, p);
                        if (normValue === 2) {
                            participantMultipliers[p] = 1;
                            totalMultiplier += 1;
                        } else if (normValue === 1) {
                            participantMultipliers[p] = 0.5;
                            totalMultiplier += 0.5;
                        }
                    });

                    if (totalMultiplier > 0) {
                        const perUnit = total / totalMultiplier;
                        Object.keys(participantMultipliers).forEach(p => {
                            if (perParticipant[p] !== undefined) {
                                perParticipant[p] += perUnit * participantMultipliers[p];
                            }
                        });
                    }
                }
            });

            state.types.forEach(type => {
                const typeIngredients = state.ingredients.filter(i => i.typeId === type.id);
                const total = typeIngredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);

                if (total > 0) {
                    let participants = type.forAll ? state.participants : (type.participants || []);
                    if (participants.length > 0) {
                        const perPerson = total / participants.length;
                        participants.forEach(p => {
                            if (perParticipant[p] !== undefined) {
                                perParticipant[p] += perPerson;
                            }
                        });
                    }
                }
            });

            return perParticipant;
        }

        // ============================================
        // PER PERSON SECTION
        // ============================================
        function renderPerPerson() {
            const section = document.getElementById('perPersonSection');
            const list = document.getElementById('perPersonList');

            if (state.participants.length === 0 && state.participantCount === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            if (state.participants.length > 0) {
                const perParticipant = calculatePerParticipant();

                list.innerHTML = '<div class="per-person-list">' +
                    Object.entries(perParticipant).map(([name, amount]) => {
                        const adjustmentStatus = getParticipantAdjustmentStatus(name);
                        const adjustments = state.participantAdjustments[name] || [];
                        const totalAdjustment = adjustments.reduce((sum, adj) => {
                            return adj.type === 'deduction' ? sum - adj.amount : sum + adj.amount;
                        }, 0);
                        const finalAmount = amount + totalAdjustment;

                        let badgeHtml = '';
                        let finalHtml = '';

                        if (adjustmentStatus) {
                            badgeHtml = `<span class="per-person-badge ${adjustmentStatus.type}">
                                ${adjustmentStatus.type === 'deduction' ? '‚ûñ –ï—Å—Ç—å –≤—ã—á–µ—Ç' : '‚ûï –ï—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ'}
                            </span>`;
                            finalHtml = `<div class="per-person-final">
                                <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                                <span class="per-person-final-amount">${formatMoney(finalAmount)}</span>
                            </div>`;
                        }

                        return `
                            <div class="per-person-item" onclick="showParticipantCalcModal('${escapeHtml(name)}')">
                                <div class="per-person-top">
                                    <span class="per-person-name">${escapeHtml(name)}</span>
                                    <span class="per-person-amount">${formatMoney(amount)}</span>
                                </div>
                                ${badgeHtml}
                                ${finalHtml}
                            </div>
                        `;
                    }).join('') +
                '</div>';
            } else {
                const baseCost = state.ingredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
                const contingency = calculateContingency();
                const totalCost = baseCost + contingency;
                const perPerson = state.participantCount > 0 ? totalCost / state.participantCount : totalCost;
                list.innerHTML = `
                    <div class="per-person-list">
                        <div class="per-person-item" style="cursor: default;">
                            <div class="per-person-top">
                                <span class="per-person-name">–° –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞</span>
                                <span class="per-person-amount">${formatMoney(perPerson)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // NORMS TABLE
        // ============================================
        function renderNormsTable() {
            const section = document.getElementById('normsSection');
            const container = document.getElementById('normsTable');
            const editable = canEdit();

            if (state.participants.length === 0 || state.dishes.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            let html = '<table class="norms-table"><thead><tr><th>–ë–ª—é–¥–æ</th>';

            state.participants.forEach(p => {
                const calories = state.participantCalories[p] || 2000;
                html += `<th class="participant-header">${escapeHtml(p)}</th>`;
            });

            html += '<th>–ò—Ç–æ–≥–æ</th></tr></thead><tbody>';

            state.types.forEach(type => {
                const typeDishes = state.dishes.filter(d => d.typeId === type.id);
                if (typeDishes.length > 0) {
                    html += `
                        <tr class="type-header-row" style="background: ${type.color}22;">
                            <td colspan="${state.participants.length + 2}" style="font-weight: 600; color: ${type.color}; text-align: left; padding: 12px;">
                                ${escapeHtml(type.name)}
                            </td>
                        </tr>
                    `;

                    typeDishes.forEach(dish => {
                        html += renderNormRow(dish, editable);
                    });
                }
            });

            const dishesWithoutType = state.dishes.filter(d => !d.typeId);
            if (dishesWithoutType.length > 0) {
                html += `
                    <tr class="type-header-row">
                        <td colspan="${state.participants.length + 2}" style="font-weight: 600; text-align: left; padding: 12px;">
                            –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        </td>
                    </tr>
                `;
                dishesWithoutType.forEach(dish => {
                    html += renderNormRow(dish, editable);
                });
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderNormRow(dish, editable) {
            let html = `<tr>
                <td style="text-align: left; font-weight: 500; padding-left: 24px;">
                    ${escapeHtml(dish.name)}
                </td>`;

            state.participants.forEach(p => {
                const normValue = getNormValue(dish.id, p);
                const selectStyle = getSelectStyle(normValue);

                html += `
                    <td>
                        <select onchange="updateNorm('${dish.id}', '${escapeHtml(p)}', this.value)" 
                            style="${selectStyle}"
                            ${!editable ? 'disabled' : ''}>
                            <option value="0" ${normValue === 0 ? 'selected' : ''}>–ù–µ –±—É–¥—É</option>
                            <option value="1" ${normValue === 1 ? 'selected' : ''}>–í–æ–∑–º–æ–∂–Ω–æ</option>
                            <option value="2" ${normValue === 2 ? 'selected' : ''}>–ë—É–¥—É</option>
                        </select>
                    </td>
                `;
            });

            const dishIngredients = state.ingredients.filter(i => i.dishId === dish.id);
            const total = dishIngredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);

            html += `<td><strong>${formatMoney(total)}</strong></td></tr>`;
            return html;
        }

        function getSelectStyle(normValue) {
            if (normValue === 0) return 'color: var(--danger); background: #fee;';
            if (normValue === 1) return 'color: var(--warning); background: #fffbe6;';
            return 'color: var(--success); background: #f0fff0;';
        }

        function updateNorm(dishId, participant, value) {
            if (!canEdit()) return;

            if (!state.norms[dishId]) {
                state.norms[dishId] = {};
            }
            state.norms[dishId][participant] = parseInt(value);
            saveSession();
            render();
        }

        // ============================================
        // SHOPPING LIST
        // ============================================
        function renderShoppingList() {
            const container = document.getElementById('shoppingList');
            const editable = canEdit();

            if (state.ingredients.length === 0) {
                container.innerHTML = '<p class="empty-message">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫</p>';
                document.getElementById('purchasedCount').textContent = '0';
                document.getElementById('totalCount').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                return;
            }

            const grouped = {};
            state.ingredients.forEach(ing => {
                const key = `${ing.name.toLowerCase().trim()}|||${(ing.shop || '').toLowerCase().trim()}|||${ing.unit}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        id: key,
                        name: ing.name,
                        shop: ing.shop,
                        unit: ing.unit,
                        quantity: 0,
                        totalPrice: 0,
                        sources: []
                    };
                }
                grouped[key].quantity += ing.quantity;
                grouped[key].totalPrice += ing.quantity * ing.price;

                if (ing.dishId) {
                    const dish = state.dishes.find(d => d.id === ing.dishId);
                    if (dish) grouped[key].sources.push(dish.name);
                }
                if (ing.typeId) {
                    const type = state.types.find(t => t.id === ing.typeId);
                    if (type) grouped[key].sources.push(type.name);
                }
            });

            const items = Object.values(grouped);
            const purchasedCount = items.filter(item => state.purchased[item.id]).length;
            const totalCount = items.length;

            document.getElementById('purchasedCount').textContent = purchasedCount;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('progressFill').style.width = totalCount > 0 ? `${(purchasedCount / totalCount) * 100}%` : '0%';

            let html = `
                <div class="shopping-item shopping-header">
                    <span></span>
                    <span>–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                    <span>–ú–∞–≥–∞–∑–∏–Ω</span>
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                </div>
            `;

            items.sort((a, b) => {
                const aPurchased = state.purchased[a.id] ? 1 : 0;
                const bPurchased = state.purchased[b.id] ? 1 : 0;
                if (aPurchased !== bPurchased) return aPurchased - bPurchased;
                return a.name.localeCompare(b.name, 'ru');
            });

            items.forEach((item) => {
                const isPurchased = state.purchased[item.id];
                const sourcesText = [...new Set(item.sources)].join(', ');
                const escapedId = item.id.replace(/'/g, "\\'");

                html += `
                    <div class="shopping-item ${isPurchased ? 'purchased' : ''}">
                        <input type="checkbox" class="shopping-checkbox" 
                            ${isPurchased ? 'checked' : ''} 
                            onchange="togglePurchased('${escapedId}')"
                            ${!editable ? 'disabled' : ''}
                            title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∫—É–ø–ª–µ–Ω–Ω–æ–µ">
                        <div class="shopping-item-name">
                            ${escapeHtml(item.name)}
                            <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: normal;">
                                ${escapeHtml(sourcesText)}
                            </div>
                        </div>
                        <span class="shopping-item-quantity">${formatQuantity(item.quantity, item.unit)}</span>
                        <span class="shopping-item-shop">${escapeHtml(item.shop || '‚Äî')}</span>
                        <span class="shopping-item-price">${formatMoney(item.totalPrice)}</span>
                    </div>
                `;
            });

            const grandTotal = items.reduce((sum, item) => sum + item.totalPrice, 0);
            const purchasedTotal = items.filter(item => state.purchased[item.id]).reduce((sum, item) => sum + item.totalPrice, 0);

            html += `
                <div class="shopping-item shopping-total">
                    <span></span>
                    <span>–ò–¢–û–ì–û</span>
                    <span>${totalCount} –ø–æ–∑.</span>
                    <span>–ö—É–ø–ª–µ–Ω–æ: ${formatMoney(purchasedTotal)}</span>
                    <span class="shopping-item-price">${formatMoney(grandTotal)}</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function togglePurchased(itemId) {
            if (!canEdit()) return;

            state.purchased[itemId] = !state.purchased[itemId];
            saveSession();
            renderShoppingList();
            renderSummary();
        }

        function formatQuantity(quantity, unit) {
            if (unit === '—à—Ç' || unit === '—É–ø') {
                return `${Math.ceil(quantity)} ${unit}`;
            }
            return `${quantity.toFixed(2)} ${unit}`;
        }

        // ============================================
        // SUMMARY
        // ============================================
        function renderSummary() {
            const container = document.getElementById('summaryContent');
            const editable = canEdit();

            const baseCost = state.ingredients.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            const contingency = calculateContingency();
            const totalCost = baseCost + contingency;
            const totalDishes = state.dishes.length;
            const participantsCount = state.participants.length || state.participantCount || 1;
            const perPerson = totalCost / participantsCount;

            const grouped = {};
            state.ingredients.forEach(ing => {
                const key = `${ing.name.toLowerCase().trim()}|||${(ing.shop || '').toLowerCase().trim()}|||${ing.unit}`;
                if (!grouped[key]) grouped[key] = { id: key, totalPrice: 0 };
                grouped[key].totalPrice += ing.quantity * ing.price;
            });

            const items = Object.values(grouped);
            const purchasedTotal = items.filter(item => state.purchased[item.id]).reduce((sum, item) => sum + item.totalPrice, 0);

            const contingencyText = state.contingency.type === 'percent' 
                ? `${state.contingency.value}% –æ—Ç —Å—É–º–º—ã`
                : '–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞';

            container.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-card highlight">
                        <div class="summary-value">${formatMoney(totalCost)}</div>
                        <div class="summary-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    </div>
                    <div class="summary-card contingency ${editable ? 'clickable' : ''}" onclick="${editable ? 'showContingencyModal()' : ''}">
                        <div class="summary-value">${formatMoney(contingency)}</div>
                        <div class="summary-label">–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
                        ${state.contingency.value > 0 ? `<div class="summary-hint">${contingencyText}</div>` : ''}
                        ${editable ? '<div class="summary-hint">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>' : ''}
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${formatMoney(perPerson)}</div>
                        <div class="summary-label">–° –∫–∞–∂–¥–æ–≥–æ (~${participantsCount} —á–µ–ª.)</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${totalDishes}</div>
                        <div class="summary-label">${pluralize(totalDishes, '–±–ª—é–¥–æ', '–±–ª—é–¥–∞', '–±–ª—é–¥')}</div>
                    </div>
                    <div class="summary-card" style="border: 2px solid var(--success);">
                        <div class="summary-value" style="color: var(--success);">${formatMoney(purchasedTotal)}</div>
                        <div class="summary-label">–£–∂–µ –∫—É–ø–ª–µ–Ω–æ</div>
                    </div>
                    <div class="summary-card" style="border: 2px solid var(--warning);">
                        <div class="summary-value" style="color: var(--warning);">${formatMoney(totalCost - purchasedTotal)}</div>
                        <div class="summary-label">–û—Å—Ç–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å</div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            } catch (e) {
                return '';
            }
        }

        function pluralize(n, one, few, many) {
            const mod10 = n % 10;
            const mod100 = n % 100;
            if (mod100 >= 11 && mod100 <= 19) return many;
            if (mod10 === 1) return one;
            if (mod10 >= 2 && mod10 <= 4) return few;
            return many;
        }

        function adjustColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, Math.max(0, (num >> 16) + amt));
            const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
            const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }
    </script>
</body>
</html>
